---
type: service_template
subtype: container
name: saas-unit-test-base
description: This is the base template for SaaS unit tests.
container:
  resources:
    mem_mib: 1536
    cpu_cores: 0.5
  image: get.applatix.io/axdb-dev:v1.7
  docker_options: 
  command: sh -c '/src/saas/common/config/cassandra-test-config.sh /etc/cassandra
    && /src/saas/common/config/kafka-test-config.sh
    && %%CMD%%'
inputs:
  artifacts:
  - from: "%%service.checkout.code%%"
    path: "/src"
  parameters:
    CMD:
    checkout:
outputs:

---
type: service_template
subtype: workflow
name: saas-unit-test-step
description: This is the workflow step for running all SaaS unit tests.
inputs:
  parameters:
    checkout:
steps:
  - axdb-test:
      template: saas-unit-test-base
      parameters:
        CMD: /src/saas/axdb/run-test.sh
  - axops-test:
      template: saas-unit-test-base
      parameters:
        CMD: /src/saas/axops/run-test-axops.sh
    event-test:
      template: saas-unit-test-base
      parameters:
        CMD: /src/saas/axops/run-test-event.sh
    modules-test:
      template: saas-unit-test-base
      parameters:
        CMD: /src/saas/axops/run-test-modules.sh
---
type: service_template
subtype: workflow
name: saas-unit-test-standalone
description: This is the workflow for running all the SaaS unit tests.
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
steps:
- checkout:
    template: axscm-checkout
- saas-test:
    template: saas-unit-test-step
    parameters:
      checkout: "%%step.checkout%%"


---
type: policy
name: Applaix SaaS Unit Test Policy
description: Policy to trigger SaaS Unit Test
template: saas-unit-test-standalone
parameters:
notifications:
  -
    when:
      - on_start
      - on_success
      - on_failure
    whom:
      - committer
      - author
  -
    when:
      - on_failure
    whom:
      - j7l5a4s7j9c5t9m3@applatix.slack.com
when:
  -
    event: on_push
    target_branches:
      - "master"
labels:
  k1: v1
  k2: v2
  k3: v3
  k4: v4
