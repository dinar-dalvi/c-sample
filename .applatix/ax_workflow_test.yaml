---
type: "service_template"
subtype: "workflow"
name: "AX Workflow Test"
description: "AX Workflow Test"
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    namespace:
      default: ""
    version:
      default: ""
fixtures:
- target_cluster:
    category: "Cluster"
steps:
- CHECKOUT:
    template: "axscm-checkout"
- BUILD_DEVOPS:
    template: "devops-build-step"
    parameters:
      checkout: "%%steps.CHECKOUT%%"
  BUILD_PLATFORM:
    template: "platform-build-step"
    parameters:
      checkout: "%%steps.CHECKOUT%%"
  BUILD_SAAS:
    template: "saas-build-step"
    parameters:
      checkout: "%%steps.CHECKOUT%%"
- DEPLOY:
    template: "axdeploy2"
    parameters:
      cluster: "%%fixtures.target_cluster.cluster_id%%"
      namespace: ""
      version: ""
- BASIC_WORKFLOW_TEST_NEGATIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/basic_workflow.py -c `cat /tmp/axops_dnsname` --negative-test'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"
  BASIC_WORKFLOW_TEST_POSITIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/basic_workflow.py -c `cat /tmp/axops_dnsname`'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"
  NESTED_WORKFLOW_TEST_NEGATIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/nested_workflow.py -c `cat /tmp/axops_dnsname` --negative-test'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"
  NESTED_WORKFLOW_TEST_POSITIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/nested_workflow.py -c `cat /tmp/axops_dnsname`'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"

---
type: "service_template"
subtype: "workflow"
name: "AX Workflow Test - Dryrun"
description: "AX Workflow Test"
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    namespace:
      default: ""
    version:
      default: ""
fixtures:
- target_cluster:
    category: "Cluster"
steps:
- CHECKOUT:
    template: "axscm-checkout"
- DEPLOY:
    template: "axdeploy2-dryrun"
    parameters:
      cluster: "%%fixtures.target_cluster.cluster_id%%"
      namespace: ""
      version: ""
- BASIC_WORKFLOW_TEST_NEGATIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'ls -l /tmp/axops_dnsname && cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/basic_workflow.py -c `cat /tmp/axops_dnsname` -u %%fixtures.target_cluster.admin_username%% -p %%fixtures.target_cluster.admin_password%% --negative-test'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"
  BASIC_WORKFLOW_TEST_POSITIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'ls -l /tmp/axops_dnsname &&  cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/basic_workflow.py -c `cat /tmp/axops_dnsname` -u %%fixtures.target_cluster.admin_username%% -p %%fixtures.target_cluster.admin_password%%'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"
  NESTED_WORKFLOW_TEST_NEGATIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'ls -l /tmp/axops_dnsname &&  cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/nested_workflow.py -c `cat /tmp/axops_dnsname` -u %%fixtures.target_cluster.admin_username%% -p %%fixtures.target_cluster.admin_password%% --negative-test'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"
  NESTED_WORKFLOW_TEST_POSITIVE:
    template: "Base AX Test"
    parameters:
      test_command: sh -c 'ls -l /tmp/axops_dnsname && cd /src && export PYTHONPATH=./common/python &&
                    python3 devops/test/ax/test/devops/e2e/workflow/nested_workflow.py -c `cat /tmp/axops_dnsname` -u %%fixtures.target_cluster.admin_username%% -p %%fixtures.target_cluster.admin_password%%'
      checkout: "%%steps.CHECKOUT%%"
      deploy: "%%steps.DEPLOY%%"

---
type: policy
name: AX Workflow Test Policy
description: Policy to trigger test with randomized workflows
template: AX Workflow Test
parameters:
  namespace: "axsys"
  version: "staging"
notifications:
  -
    when:
      - on_start
      - on_success
      - on_failure
    whom:
      - committer
      - author
  -
    when:
      - on_change
    whom:
      - j7l5a4s7j9c5t9m3@applatix.slack.com
when:
  -
    event: on_cron
    target_branches:
      - "master"
    schedule: "0 0 * * *"
    timezone: "US/Pacific"