---
type: service_template
subtype: container
name: axtool
description: axtool
container:
  resources:
    mem_mib: 500
    cpu_cores: 0.1
  image: get.applatix.io/prod/axclustermanager
  docker_options: ""
  command: bash -c "/ax/bin/axtool platform %%action%% --cluster-name %%cluster%% --image-namespace %%namespace%% --image-version %%version%% &&
           kubectl get services -o wide --kubeconfig=/tmp/ax_kube/cluster_%%cluster%%.conf --namespace axsys | grep axops | awk '{print $3}' > /tmp/axops_dnsname"
inputs:
  parameters:
    cluster:
      default: ""
    namespace:
      default: ""
    version:
      default: ""
    action:
      default: ""
outputs:
  artifacts:
    axops_dnsname:
      path: /tmp/axops_dnsname

---
type: service_template
subtype: workflow
name: Platform reset
description: Platform reset to 1.0.1
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    namespace:
      default: ""
    version:
      default: ""
fixtures:
- target_cluster:
    category: Cluster
steps:
- RESET:
    template: axtool
    parameters:
      cluster: "%%fixtures.target_cluster.cluster_id%%"
      namespace: axsys
      version: 1.0.2-ca8faba
      action: reset

---
type: service_template
subtype: workflow
name: Platform renaissance
description: Platform renaissance to 1.0.1
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    namespace:
      default: ""
    version:
      default: ""
fixtures:
- target_cluster:
    category: Cluster
steps:
- RENAISSANCE:
    template: axtool
    parameters:
      cluster: "%%fixtures.target_cluster.cluster_id%%"
      namespace: axsys
      version: 1.0.2-ca8faba
      action: renaissance

---
type: service_template
subtype: workflow
name: Applatix Platform Upgrade Test
description: Platform upgrade to specified version
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    namespace:
      default: "platform"
    version:
      default: "upgrade-test"
fixtures:
- target_cluster:
    category: Cluster
steps:
- CHECKOUT:
    template: axscm-checkout
- RESET:
    template: axtool
    parameters:
      cluster: "%%fixtures.target_cluster.cluster_id%%"
      namespace: axsys
      version: 1.0.2-ca8faba
      action: reset
  BUILD_DEVOPS:
    template: devops-build-step
    parameters:
      checkout: "%%steps.CHECKOUT%%"
  BUILD_PLATFORM:
    template: platform-build-step
    parameters:
      checkout: "%%steps.CHECKOUT%%"
  BUILD_SAAS:
    template: saas-build-step
    parameters:
      checkout: "%%steps.CHECKOUT%%"
- UPGRADE:
    template: axtool
    parameters:
      cluster: "%%fixtures.target_cluster.cluster_id%%"
      namespace: ""
      version: ""
      action: upgrade

---
type: policy
name: Platform upgrade every 30 minutes
description: Upgrade from 1.0.2 to latest every 30 minutes
template: Applatix Platform Upgrade Test
parameters:
  namespace: "platform"
  version: "upgrade-test"
when:
  -
    event: on_cron
    target_branches:
      - ".*"
    schedule: "7,37 * * * *"
    timezone: "US/Pacific"

---
type: policy
name: Platform upgrade every hour
description: Upgrade from 1.0.2 to latest every hour
template: Applatix Platform Upgrade Test
parameters:
  namespace: "platform"
  version: "upgrade-test"
when:
  -
    event: on_cron
    target_branches:
      - ".*"
    schedule: "37 * * * *"
    timezone: "US/Pacific"

---
type: policy
name: Platform upgrade every morning
description: Upgrade from 1.0.2 to latest every morning
template: Applatix Platform Upgrade Test
parameters:
  namespace: "platform"
  version: "upgrade-test"
when:
  -
    event: on_cron
    target_branches:
      - ".*"
    schedule: "13 6 * * *"
    timezone: "US/Pacific"
